# โ Install everything you need
!pip install --quiet --upgrade torch --extra-index-url https://download.pytorch.org/whl/cu118
!pip install --quiet transformers librosa soundfile torchaudio jiwer pydub noisereduce
!apt install -y ffmpeg

# โ Imports
import os
import librosa
import numpy as np
import re
import torch
import noisereduce as nr
from transformers import pipeline
from jiwer import wer
from pydub import AudioSegment
from tqdm import tqdm

# โ Load Whisper ASR model (after fixing torch)
device = 0 if torch.cuda.is_available() else -1
asr_pipeline = pipeline(
    "automatic-speech-recognition",
    model="openai/whisper-large-v3-turbo",
    device=device
)

# โ Preprocessing functions
def transcribe_audio(file_path):
    audio = AudioSegment.from_mp3(file_path).set_channels(1).set_frame_rate(16000)
    samples = np.array(audio.get_array_of_samples()).astype(np.float32) / (2**15)
    trimmed, _ = librosa.effects.trim(samples)
    denoised = nr.reduce_noise(y=trimmed, sr=16000)
    normalized = librosa.util.normalize(denoised)
    result = asr_pipeline(normalized, generate_kwargs={"language": "ar"})
    return result["text"]

# โ Reference verses of Surah An-Naba
an_naba_verses = [
    "ุนูููู ููุชูุณูุงุกูููููู", "ุนููู ุงููููุจูุฅู ุงููุนูุธูููู", "ุงูููุฐูู ูููู ููููู ููุฎูุชูููููููู",
    "ูููููุง ุณูููุนูููููููู", "ุซูููู ูููููุง ุณูููุนูููููููู", "ุฃููููู ููุฌูุนููู ุงููุฃูุฑูุถู ููููุงุฏูุง",
    "ููุงููุฌูุจูุงูู ุฃูููุชูุงุฏูุง", "ููุฎูููููููุงูููู ุฃูุฒูููุงุฌูุง", "ููุฌูุนูููููุง ูููููููููู ุณูุจูุงุชูุง",
    "ููุฌูุนูููููุง ุงูููููููู ููุจูุงุณูุง", "ููุฌูุนูููููุง ุงููููููุงุฑู ููุนูุงุดูุง", "ููุจูููููููุง ูููููููููู ุณูุจูุนูุง ุดูุฏูุงุฏูุง",
    "ููุฌูุนูููููุง ุณูุฑูุงุฌูุง ูููููุงุฌูุง", "ููุฃูููุฒูููููุง ูููู ุงููููุนูุตูุฑูุงุชู ููุงุกู ุซูุฌููุงุฌูุง",
    "ููููุฎูุฑูุฌู ุจููู ุญูุจููุง ููููุจูุงุชูุง", "ููุฌููููุงุชู ุฃูููููุงููุง", "ุฅูููู ูููููู ุงููููุตููู ููุงูู ูููููุงุชูุง",
    "ูููููู ูููููุฎู ููู ุงูุตูููุฑู ููุชูุฃูุชูููู ุฃูููููุงุฌูุง", "ููููุชูุญูุชู ุงูุณููููุงุกู ููููุงููุชู ุฃูุจูููุงุจูุง",
    "ููุณููููุฑูุชู ุงููุฌูุจูุงูู ููููุงููุชู ุณูุฑูุงุจูุง", "ุฅูููู ุฌูููููููู ููุงููุชู ููุฑูุตูุงุฏูุง",
    "ูููุทููุงุบูููู ููุขุจูุง", "ููุงุจูุซูููู ูููููุง ุฃูุญูููุงุจูุง", "ููุง ููุฐููููููู ูููููุง ุจูุฑูุฏูุง ููููุง ุดูุฑูุงุจูุง",
    "ุฅููููุง ุญููููููุง ููุบูุณููุงููุง", "ุฌูุฒูุงุกู ููููุงููุง", "ุฅูููููููู ููุงูููุง ููุง ููุฑูุฌูููู ุญูุณูุงุจูุง",
    "ููููุฐููุจููุง ุจูุขููุงุชูููุง ููุฐููุงุจูุง", "ููููููู ุดูููุกู ุฃูุญูุตูููููุงูู ููุชูุงุจูุง",
    "ููุฐูููููุง ูููููู ููุฒููุฏููููู ุฅููููุง ุนูุฐูุงุจูุง", "ุฅูููู ููููููุชููููููู ููููุงุฒูุง", "ุญูุฏูุงุฆููู ููุฃูุนูููุงุจูุง",
    "ููููููุงุนูุจู ุฃูุชูุฑูุงุจูุง", "ููููุฃูุณูุง ุฏูููุงููุง", "ููุง ููุณูููุนูููู ูููููุง ููุบูููุง ููููุง ููุฐููุงุจูุง",
    "ุฌูุฒูุงุกู ูููู ุฑููุจูููู ุนูุทูุงุกู ุญูุณูุงุจูุง", "ุฑููุจูู ุงูุณููููุงููุงุชู ููุงููุฃูุฑูุถู ููููุง ุจูููููููููุง ุงูุฑููุญููููฐูู ููุง ููููููููููู ูููููู ุฎูุทูุงุจูุง",
    "ูููููู ููููููู ุงูุฑูููุญู ููุงููููููุงุฆูููุฉู ุตููููุง ูููุง ููุชููููููููููู ุฅููููุง ูููู ุฃูุฐููู ูููู ุงูุฑููุญููููฐูู ููููุงูู ุตูููุงุจูุง",
    "ุฐููฐูููู ุงูููููููู ุงููุญูููู  ููููู ุดูุงุกู ุงุชููุฎูุฐู ุฅูููููฐ ุฑูุจูููู ููุขุจูุง",
    "ุฅููููุง ุฃููุฐูุฑูููุงูููู ุนูุฐูุงุจูุง ููุฑููุจูุง ูููููู ูููุธูุฑู ุงููููุฑูุกู ููุง ููุฏููููุชู ููุฏูุงูู ููููููููู ุงููููุงููุฑู ููุง ููููุชูููู ูููุชู ุชูุฑูุงุจูุง"
]

# โ Run evaluation on each reciter folder
root_dir = "./an-naba"
reciters = [d for d in os.listdir(root_dir) if os.path.isdir(os.path.join(root_dir, d)) and not d.startswith('.')]

for reciter in reciters:
    print(f"\n๐๏ธ Reciter: {reciter}")
    reciter_path = os.path.join(root_dir, reciter)
    total_wer = 0

    for i in tqdm(range(1, 41)):
        file_path = os.path.join(reciter_path, f"{i}.mp3")
        pred = transcribe_audio(file_path)
        ref = an_naba_verses[i - 1]
        score = wer(ref, pred)
        total_wer += score

        print(f"\n๐ Ayah {i}")
        print(f"โ Reference : {ref}")
        print(f"๐ง Predicted : {pred}")
        print(f"๐ WER       : {score:.2%}")

    avg_wer = total_wer / 40
    print(f"\n๐ Average WER for {reciter}: {avg_wer:.2%}")
