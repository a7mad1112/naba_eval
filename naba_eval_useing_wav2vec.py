!pip install noisereduce transformers librosa soundfile torchaudio jiwer
!pip install pydub
!apt install ffmpeg

import os
import librosa
import numpy as np
import re
import torch
import noisereduce as nr
from transformers import pipeline
from jiwer import wer
from pydub import AudioSegment
from tqdm import tqdm

# ðŸ§  Load ASR model
device = 0 if torch.cuda.is_available() else -1
asr_pipeline = pipeline(
    "automatic-speech-recognition",
    model="elgeish/wav2vec2-large-xlsr-53-arabic",
    device=device
)

# ðŸŒ Buckwalter to Arabic map
def buckwalter_to_arabic(text):
    buck2arab = {
        "A": "Ø§", "b": "Ø¨", "t": "Øª", "v": "Ø«", "j": "Ø¬", "H": "Ø­", "x": "Ø®",
        "d": "Ø¯", "r": "Ø±", "z": "Ø²", "s": "Ø³", "E": "Ø¹", "g": "Øº", "f": "Ù",
        "q": "Ù‚", "k": "Ùƒ", "l": "Ù„", "m": "Ù…", "n": "Ù†", "h": "Ù‡", "w": "Ùˆ",
        "y": "ÙŠ", "T": "Ø·", "Z": "Ø¸", "S": "Øµ", "D": "Ø¶", "Y": "Ù‰", "e": "Ø©",
        "a": "ÙŽ", "u": "Ù", "i": "Ù", "o": "ÙŒ", "~": "Ù‘", "â€™": "Ø¡", "'": "Ø£",
        ">": "Ø¥", "<": "Ø§", "|": "Ø¢", "}": "Ø¦", "&": "Ø¤", "$": "Ø´", "`": "Ù‹",
        "{": "Ø¦", ":": ":", "\"": "\"", " ": " ", "\n": "\n"
    }
    return ''.join([buck2arab.get(c, '') for c in text])

# ðŸ§¹ Clean Buckwalter text
def clean_buckwalter(text):
    return re.sub(r"[^A-Za-z\$\>\<\{\}\&\~\|\'\: ]", "", text)

# ðŸŽµ Process single file
def transcribe_audio(file_path):
    audio = AudioSegment.from_mp3(file_path).set_channels(1).set_frame_rate(16000)
    samples = np.array(audio.get_array_of_samples()).astype(np.float32) / (2**15)
    trimmed, _ = librosa.effects.trim(samples)
    denoised = nr.reduce_noise(y=trimmed, sr=16000)
    normalized = librosa.util.normalize(denoised)
    result = asr_pipeline(normalized)
    text = result['text']
    return buckwalter_to_arabic(clean_buckwalter(text))

# ðŸ“– Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ø¨Ø£ ÙƒØ§Ù…Ù„Ø© (Ù…Ù†Ù‚Ø­Ø© Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…ØµØ­Ù)
an_naba_verses = [
    "Ø¹ÙŽÙ…Ù‘ÙŽ ÙŠÙŽØªÙŽØ³ÙŽØ§Ø¡ÙŽÙ„ÙÙˆÙ†ÙŽ", "Ø¹ÙŽÙ†Ù Ø§Ù„Ù†Ù‘ÙŽØ¨ÙŽØ¥Ù Ø§Ù„Ù’Ø¹ÙŽØ¸ÙÙŠÙ…Ù", "Ø§Ù„Ù‘ÙŽØ°ÙÙŠ Ù‡ÙÙ…Ù’ ÙÙÙŠÙ‡Ù Ù…ÙØ®Ù’ØªÙŽÙ„ÙÙÙÙˆÙ†ÙŽ",
    "ÙƒÙŽÙ„Ù‘ÙŽØ§ Ø³ÙŽÙŠÙŽØ¹Ù’Ù„ÙŽÙ…ÙÙˆÙ†ÙŽ", "Ø«ÙÙ…Ù‘ÙŽ ÙƒÙŽÙ„Ù‘ÙŽØ§ Ø³ÙŽÙŠÙŽØ¹Ù’Ù„ÙŽÙ…ÙÙˆÙ†ÙŽ", "Ø£ÙŽÙ„ÙŽÙ…Ù’ Ù†ÙŽØ¬Ù’Ø¹ÙŽÙ„Ù Ø§Ù„Ù’Ø£ÙŽØ±Ù’Ø¶ÙŽ Ù…ÙÙ‡ÙŽØ§Ø¯Ù‹Ø§",
    "ÙˆÙŽØ§Ù„Ù’Ø¬ÙØ¨ÙŽØ§Ù„ÙŽ Ø£ÙŽÙˆÙ’ØªÙŽØ§Ø¯Ù‹Ø§", "ÙˆÙŽØ®ÙŽÙ„ÙŽÙ‚Ù’Ù†ÙŽØ§ÙƒÙÙ…Ù’ Ø£ÙŽØ²Ù’ÙˆÙŽØ§Ø¬Ù‹Ø§", "ÙˆÙŽØ¬ÙŽØ¹ÙŽÙ„Ù’Ù†ÙŽØ§ Ù†ÙŽÙˆÙ’Ù…ÙŽÙƒÙÙ…Ù’ Ø³ÙØ¨ÙŽØ§ØªÙ‹Ø§",
    "ÙˆÙŽØ¬ÙŽØ¹ÙŽÙ„Ù’Ù†ÙŽØ§ Ø§Ù„Ù„Ù‘ÙŽÙŠÙ’Ù„ÙŽ Ù„ÙØ¨ÙŽØ§Ø³Ù‹Ø§", "ÙˆÙŽØ¬ÙŽØ¹ÙŽÙ„Ù’Ù†ÙŽØ§ Ø§Ù„Ù†Ù‘ÙŽÙ‡ÙŽØ§Ø±ÙŽ Ù…ÙŽØ¹ÙŽØ§Ø´Ù‹Ø§", "ÙˆÙŽØ¨ÙŽÙ†ÙŽÙŠÙ’Ù†ÙŽØ§ ÙÙŽÙˆÙ’Ù‚ÙŽÙƒÙÙ…Ù’ Ø³ÙŽØ¨Ù’Ø¹Ù‹Ø§ Ø´ÙØ¯ÙŽØ§Ø¯Ù‹Ø§",
    "ÙˆÙŽØ¬ÙŽØ¹ÙŽÙ„Ù’Ù†ÙŽØ§ Ø³ÙØ±ÙŽØ§Ø¬Ù‹Ø§ ÙˆÙŽÙ‡Ù‘ÙŽØ§Ø¬Ù‹Ø§", "ÙˆÙŽØ£ÙŽÙ†Ù’Ø²ÙŽÙ„Ù’Ù†ÙŽØ§ Ù…ÙÙ†ÙŽ Ø§Ù„Ù’Ù…ÙØ¹Ù’ØµÙØ±ÙŽØ§ØªÙ Ù…ÙŽØ§Ø¡Ù‹ Ø«ÙŽØ¬Ù‘ÙŽØ§Ø¬Ù‹Ø§",
    "Ù„ÙÙ†ÙØ®Ù’Ø±ÙØ¬ÙŽ Ø¨ÙÙ‡Ù Ø­ÙŽØ¨Ù‘Ù‹Ø§ ÙˆÙŽÙ†ÙŽØ¨ÙŽØ§ØªÙ‹Ø§", "ÙˆÙŽØ¬ÙŽÙ†Ù‘ÙŽØ§ØªÙ Ø£ÙŽÙ„Ù’ÙÙŽØ§ÙÙ‹Ø§", "Ø¥ÙÙ†Ù‘ÙŽ ÙŠÙŽÙˆÙ’Ù…ÙŽ Ø§Ù„Ù’ÙÙŽØµÙ’Ù„Ù ÙƒÙŽØ§Ù†ÙŽ Ù…ÙÙŠÙ‚ÙŽØ§ØªÙ‹Ø§",
    "ÙŠÙŽÙˆÙ’Ù…ÙŽ ÙŠÙÙ†ÙÙŽØ®Ù ÙÙÙŠ Ø§Ù„ØµÙ‘ÙÙˆØ±Ù ÙÙŽØªÙŽØ£Ù’ØªÙÙˆÙ†ÙŽ Ø£ÙŽÙÙ’ÙˆÙŽØ§Ø¬Ù‹Ø§", "ÙˆÙŽÙÙØªÙØ­ÙŽØªÙ Ø§Ù„Ø³Ù‘ÙŽÙ…ÙŽØ§Ø¡Ù ÙÙŽÙƒÙŽØ§Ù†ÙŽØªÙ’ Ø£ÙŽØ¨Ù’ÙˆÙŽØ§Ø¨Ù‹Ø§",
    "ÙˆÙŽØ³ÙÙŠÙ‘ÙØ±ÙŽØªÙ Ø§Ù„Ù’Ø¬ÙØ¨ÙŽØ§Ù„Ù ÙÙŽÙƒÙŽØ§Ù†ÙŽØªÙ’ Ø³ÙŽØ±ÙŽØ§Ø¨Ù‹Ø§", "Ø¥ÙÙ†Ù‘ÙŽ Ø¬ÙŽÙ‡ÙŽÙ†Ù‘ÙŽÙ…ÙŽ ÙƒÙŽØ§Ù†ÙŽØªÙ’ Ù…ÙØ±Ù’ØµÙŽØ§Ø¯Ù‹Ø§",
    "Ù„ÙÙ„Ø·Ù‘ÙŽØ§ØºÙÙŠÙ†ÙŽ Ù…ÙŽØ¢Ø¨Ù‹Ø§", "Ù„ÙŽØ§Ø¨ÙØ«ÙÙŠÙ†ÙŽ ÙÙÙŠÙ‡ÙŽØ§ Ø£ÙŽØ­Ù’Ù‚ÙŽØ§Ø¨Ù‹Ø§", "Ù„ÙŽØ§ ÙŠÙŽØ°ÙÙˆÙ‚ÙÙˆÙ†ÙŽ ÙÙÙŠÙ‡ÙŽØ§ Ø¨ÙŽØ±Ù’Ø¯Ù‹Ø§ ÙˆÙŽÙ„ÙŽØ§ Ø´ÙŽØ±ÙŽØ§Ø¨Ù‹Ø§",
    "Ø¥ÙÙ„Ù‘ÙŽØ§ Ø­ÙŽÙ…ÙÙŠÙ…Ù‹Ø§ ÙˆÙŽØºÙŽØ³Ù‘ÙŽØ§Ù‚Ù‹Ø§", "Ø¬ÙŽØ²ÙŽØ§Ø¡Ù‹ ÙˆÙÙÙŽØ§Ù‚Ù‹Ø§", "Ø¥ÙÙ†Ù‘ÙŽÙ‡ÙÙ…Ù’ ÙƒÙŽØ§Ù†ÙÙˆØ§ Ù„ÙŽØ§ ÙŠÙŽØ±Ù’Ø¬ÙÙˆÙ†ÙŽ Ø­ÙØ³ÙŽØ§Ø¨Ù‹Ø§",
    "ÙˆÙŽÙƒÙŽØ°Ù‘ÙŽØ¨ÙÙˆØ§ Ø¨ÙØ¢ÙŠÙŽØ§ØªÙÙ†ÙŽØ§ ÙƒÙØ°Ù‘ÙŽØ§Ø¨Ù‹Ø§", "ÙˆÙŽÙƒÙÙ„Ù‘ÙŽ Ø´ÙŽÙŠÙ’Ø¡Ù Ø£ÙŽØ­Ù’ØµÙŽÙŠÙ’Ù†ÙŽØ§Ù‡Ù ÙƒÙØªÙŽØ§Ø¨Ù‹Ø§",
    "ÙÙŽØ°ÙÙˆÙ‚ÙÙˆØ§ ÙÙŽÙ„ÙŽÙ†Ù’ Ù†ÙŽØ²ÙÙŠØ¯ÙŽÙƒÙÙ…Ù’ Ø¥ÙÙ„Ù‘ÙŽØ§ Ø¹ÙŽØ°ÙŽØ§Ø¨Ù‹Ø§", "Ø¥ÙÙ†Ù‘ÙŽ Ù„ÙÙ„Ù’Ù…ÙØªÙ‘ÙŽÙ‚ÙÙŠÙ†ÙŽ Ù…ÙŽÙÙŽØ§Ø²Ù‹Ø§", "Ø­ÙŽØ¯ÙŽØ§Ø¦ÙÙ‚ÙŽ ÙˆÙŽØ£ÙŽØ¹Ù’Ù†ÙŽØ§Ø¨Ù‹Ø§",
    "ÙˆÙŽÙƒÙŽÙˆÙŽØ§Ø¹ÙØ¨ÙŽ Ø£ÙŽØªÙ’Ø±ÙŽØ§Ø¨Ù‹Ø§", "ÙˆÙŽÙƒÙŽØ£Ù’Ø³Ù‹Ø§ Ø¯ÙÙ‡ÙŽØ§Ù‚Ù‹Ø§", "Ù„ÙŽØ§ ÙŠÙŽØ³Ù’Ù…ÙŽØ¹ÙÙˆÙ†ÙŽ ÙÙÙŠÙ‡ÙŽØ§ Ù„ÙŽØºÙ’ÙˆÙ‹Ø§ ÙˆÙŽÙ„ÙŽØ§ ÙƒÙØ°Ù‘ÙŽØ§Ø¨Ù‹Ø§",
    "Ø¬ÙŽØ²ÙŽØ§Ø¡Ù‹ Ù…ÙÙ‘Ù† Ø±Ù‘ÙŽØ¨ÙÙ‘ÙƒÙŽ Ø¹ÙŽØ·ÙŽØ§Ø¡Ù‹ Ø­ÙØ³ÙŽØ§Ø¨Ù‹Ø§", "Ø±Ù‘ÙŽØ¨ÙÙ‘ Ø§Ù„Ø³Ù‘ÙŽÙ…ÙŽØ§ÙˆÙŽØ§ØªÙ ÙˆÙŽØ§Ù„Ù’Ø£ÙŽØ±Ù’Ø¶Ù ÙˆÙŽÙ…ÙŽØ§ Ø¨ÙŽÙŠÙ’Ù†ÙŽÙ‡ÙÙ…ÙŽØ§ Ø§Ù„Ø±Ù‘ÙŽØ­Ù’Ù…ÙŽÙ°Ù†Ù Ù„ÙŽØ§ ÙŠÙŽÙ…Ù’Ù„ÙÙƒÙÙˆÙ†ÙŽ Ù…ÙÙ†Ù’Ù‡Ù Ø®ÙØ·ÙŽØ§Ø¨Ù‹Ø§",
    "ÙŠÙŽÙˆÙ’Ù…ÙŽ ÙŠÙŽÙ‚ÙÙˆÙ…Ù Ø§Ù„Ø±Ù‘ÙÙˆØ­Ù ÙˆÙŽØ§Ù„Ù’Ù…ÙŽÙ„ÙŽØ§Ø¦ÙÙƒÙŽØ©Ù ØµÙŽÙÙ‘Ù‹Ø§ Ù„Ù‘ÙŽØ§ ÙŠÙŽØªÙŽÙƒÙŽÙ„Ù‘ÙŽÙ…ÙÙˆÙ†ÙŽ Ø¥ÙÙ„Ù‘ÙŽØ§ Ù…ÙŽÙ†Ù’ Ø£ÙŽØ°ÙÙ†ÙŽ Ù„ÙŽÙ‡Ù Ø§Ù„Ø±Ù‘ÙŽØ­Ù’Ù…ÙŽÙ°Ù†Ù ÙˆÙŽÙ‚ÙŽØ§Ù„ÙŽ ØµÙŽÙˆÙŽØ§Ø¨Ù‹Ø§",
    "Ø°ÙŽÙ°Ù„ÙÙƒÙŽ Ø§Ù„Ù’ÙŠÙŽÙˆÙ’Ù…Ù Ø§Ù„Ù’Ø­ÙŽÙ‚Ù‘Ù Û– ÙÙŽÙ…ÙŽÙ† Ø´ÙŽØ§Ø¡ÙŽ Ø§ØªÙ‘ÙŽØ®ÙŽØ°ÙŽ Ø¥ÙÙ„ÙŽÙ‰Ù° Ø±ÙŽØ¨ÙÙ‘Ù‡Ù Ù…ÙŽØ¢Ø¨Ù‹Ø§",
    "Ø¥ÙÙ†Ù‘ÙŽØ§ Ø£ÙŽÙ†Ø°ÙŽØ±Ù’Ù†ÙŽØ§ÙƒÙÙ…Ù’ Ø¹ÙŽØ°ÙŽØ§Ø¨Ù‹Ø§ Ù‚ÙŽØ±ÙÙŠØ¨Ù‹Ø§ ÙŠÙŽÙˆÙ’Ù…ÙŽ ÙŠÙŽÙ†Ø¸ÙØ±Ù Ø§Ù„Ù’Ù…ÙŽØ±Ù’Ø¡Ù Ù…ÙŽØ§ Ù‚ÙŽØ¯Ù‘ÙŽÙ…ÙŽØªÙ’ ÙŠÙŽØ¯ÙŽØ§Ù‡Ù ÙˆÙŽÙŠÙŽÙ‚ÙÙˆÙ„Ù Ø§Ù„Ù’ÙƒÙŽØ§ÙÙØ±Ù ÙŠÙŽØ§ Ù„ÙŽÙŠÙ’ØªÙŽÙ†ÙÙŠ ÙƒÙÙ†ØªÙ ØªÙØ±ÙŽØ§Ø¨Ù‹Ø§"
]

# ðŸ§ª Main Evaluation
root_dir = "./an-naba"
reciters = [d for d in os.listdir(root_dir) if os.path.isdir(os.path.join(root_dir, d)) and not d.startswith('.')]

for reciter in reciters:
    print(f"\nðŸŽ™ï¸ Reciter: {reciter}")
    reciter_path = os.path.join(root_dir, reciter)
    total_wer = 0

    for i in tqdm(range(1, 41)):
        print(f"Current working directory: {os.getcwd()}")
        file_path = os.path.join(reciter_path, f"{i}.mp3")
        print(f"Accessing file: {file_path}")
        pred = transcribe_audio(file_path)
        ref = an_naba_verses[i - 1]
        score = wer(ref, pred)
        total_wer += score

        print(f"\nðŸ“Œ Ayah {i}")
        print(f"âœ… Reference : {ref}")
        print(f"ðŸ§  Predicted : {pred}")
        print(f"ðŸ“‰ WER       : {score:.2%}")

    avg_wer = total_wer / 40
    print(f"\nðŸ“Š Average WER for {reciter}: {avg_wer:.2%}")

